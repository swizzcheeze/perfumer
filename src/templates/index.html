<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfumery Ingredient Manager</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    
    <style>
        /* Inline styles are generally for quick overrides or very specific, non-reusable cases. 
           Most of these should ideally be in your styles.css for better organization.
        */
        .inline-edit-input { padding: 0.25rem 0.5rem; font-size: inherit; border: 1px solid #ced4da; border-radius: 0.25rem; width: 100%; box-sizing: border-box; }
        .table th.sortable-header { cursor: pointer; user-select: none; }
        /* :hover styles are better in CSS file for specificity with dark mode */

        .table .form-select-sm { padding-top: 0.25rem; padding-bottom: 0.25rem; padding-left: 0.5rem; font-size: .875em; }
        .action-buttons-inline-edit button { margin-right: 2px; }
        .notes-cell { 
            display: -webkit-box; 
            -webkit-box-orient: vertical; 
            -webkit-line-clamp: 2; 
            line-clamp: 2; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            max-height: 3.2em; 
            line-height: 1.6em; 
            cursor: default; 
            white-space: normal; 
        }
        .amount-value { font-weight: 600; display: inline; }
        .unit-value { display: inline; font-size: 0.9em; color: #555; margin-left: 0.25em; } 
        .times-symbol { margin: 0 0.25em; font-size: 0.9em; }
        /* .table-info and dark mode overrides are in styles.css */
        
        /* .nav-pills styles are in styles.css */

        .table-xs { font-size: 0.8rem; }
        .table-xs th, .table-xs td { padding: 0.25rem 0.4rem; }
        .btn-xs { padding: 0.1rem 0.3rem; font-size: 0.75rem; }
    </style>
</head>
<body> 
    <div id="app" class="app-container">
        {% raw %}
        
        <header class="app-header">
            <div class="header-left">
                <i class="bi bi-droplet-half fs-3 me-2"></i> 
                <h1>Perfumery Manager</h1>
            </div>
            <div class="d-flex align-items-center">
                <ul class="nav nav-pills me-3">
                    <li class="nav-item">
                        <a class="nav-link" :class="{ active: currentMainView === 'ingredients' }" href="#" @click.prevent="currentMainView = 'ingredients'; initialPerPageAdjustDone = false; $nextTick(() => adjustPerPageItems());">
                            <i class="bi bi-list-ul"></i> Ingredients
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" :class="{ active: currentMainView === 'formulas' }" href="#" @click.prevent="currentMainView = 'formulas'">
                            <i class="bi bi-journal-album"></i> Formulas
                        </a>
                    </li>
                </ul>

                <button @click="openApiSettingsModal" class="btn btn-outline-secondary btn-sm me-2" title="API Key Settings">
                    <i class="bi bi-key-fill"></i> API Keys
                </button>

                <button @click="toggleDarkMode" class="theme-toggle-button btn btn-sm" 
                        :title="isDarkMode ? 'Switch to Light Mode' : 'Switch to Dark Mode'">
                    <i class="bi" :class="isDarkMode ? 'bi-sun-fill' : 'bi-moon-stars-fill'"></i>
                </button>
                <div class="summary-cards ms-3 d-none d-lg-flex"> 
                    <div class="summary-card">
                        <i class="bi bi-box-seam"></i>
                        <div><div>Ingredients</div><strong class="fs-5">{{ ingredientPagination.total_items }}</strong></div>
                    </div>
                     <div class="summary-card">
                        <i class="bi bi-journal-richtext"></i>
                        <div><div>Formulas</div><strong class="fs-5">{{ formulaPagination.total_items }}</strong></div>
                    </div>
                    <div class="summary-card">
                        <i class="bi bi-tags"></i>
                        <div><div>Categories</div><strong class="fs-5">{{ categories.length }}</strong></div>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="app-body">
            <aside class="left-sidebar">
                <div class="sidebar-panel" v-if="currentMainView === 'ingredients'">
                    <h5 class="mb-3">Add New Ingredient</h5>
                    <form @submit.prevent="addIngredientFromPanel">
                        <div class="mb-3"><label for="quickAddIngredientName" class="form-label">Ingredient Name</label><input type="text" class="form-control form-control-sm" id="quickAddIngredientName" v-model="newIngredientPanel.name" required></div>
                        <div class="mb-3"><label for="quickAddIngredientAmount" class="form-label">Total Amount</label><input type="number" step="any" class="form-control form-control-sm" id="quickAddIngredientAmount" v-model.number="newIngredientPanel.amount"></div>
                        <div class="mb-3"><label for="quickAddIngredientUnit" class="form-label">Unit</label><select class="form-select form-select-sm" id="quickAddIngredientUnit" v-model="newIngredientPanel.unit"><option value="g">g</option><option value="mL">mL</option><option value="oz">oz</option><option value="drops">drops</option></select></div>
                        <div class="mb-3"><label for="quickAddIngredientCategories" class="form-label">Categories (Max 3)</label><select multiple class="form-select form-select-sm" size="3" id="quickAddIngredientCategories" v-model="newIngredientPanel.category_ids"><option v-for="category in categories" :value="category.id" :key="category.id">{{ category.name }}</option></select><small class="form-text text-muted">Ctrl/Cmd+click.</small></div>
                        <div class="mb-3"><label for="quickAddIngredientNotes" class="form-label">Notes (Optional)</label><textarea class="form-control form-control-sm" id="quickAddIngredientNotes" rows="2" v-model="newIngredientPanel.notes"></textarea></div>
                        <button type="submit" class="btn btn-primary btn-sm w-100">Add Ingredient</button>
                    </form>
                </div>
                <div class="sidebar-panel" v-if="currentMainView === 'formulas'">
                    <h5 class="mb-3">Formula Tools</h5>
                    <button class="btn btn-primary btn-sm w-100 mb-2" @click="openFormulaModal('add')">
                        <i class="bi bi-plus-circle"></i> Add New Formula
                    </button>
                    <p class="text-muted small">More formula-specific quick actions or filters can be added here.</p>
                </div>
            </aside>
            
            <main class="main-content" v-if="currentMainView === 'ingredients'">
                <div class="main-content-header">
                    <h2>Ingredients Inventory</h2>
                    <div class="filters-toolbar">
                        <div class="input-group input-group-sm me-2 flex-grow-1"><input type="text" class="form-control" placeholder="Search ingredients..." v-model="ingredientSearch" @keyup.enter="triggerSearch()"><button class="btn btn-outline-secondary" type="button" @click="triggerSearch()"><i class="bi bi-search"></i></button></div>
                        <select class="form-select form-select-sm me-2" v-model="ingredientCategoryFilter" @change="loadIngredients()" style="width: auto; min-width: 150px;"><option value="">All Categories</option><option v-for="category in categories" :value="category.id" :key="category.id">{{ category.name }}</option></select>
                        <button class="btn btn-outline-secondary btn-sm" @click="clearFiltersAndSort"><i class="bi bi-x-circle"></i> Clear</button>
                    </div>
                </div>
                <nav aria-label="Ingredient pagination" v-if="ingredientPagination.total_pages > 1" class="my-3"> <ul class="pagination justify-content-center pagination-sm"><li class="page-item" :class="{ disabled: ingredientPagination.page === 1 }"><a class="page-link" href="#" @click.prevent="changePage(1)" title="First Page"><i class="bi bi-chevron-bar-left"></i></a></li><li class="page-item" :class="{ disabled: ingredientPagination.page === 1 }"><a class="page-link" href="#" @click.prevent="changePage(ingredientPagination.page - 1)" title="Previous Page"><i class="bi bi-chevron-left"></i></a></li><li v-for="pageNumber in pageNumbers" :key="pageNumber" class="page-item" :class="{ active: pageNumber === ingredientPagination.page }"><a class="page-link" href="#" @click.prevent="changePage(pageNumber)">{{ pageNumber }}</a></li><li class="page-item" :class="{ disabled: ingredientPagination.page === ingredientPagination.total_pages }"><a class="page-link" href="#" @click.prevent="changePage(ingredientPagination.page + 1)" title="Next Page"><i class="bi bi-chevron-right"></i></a></li><li class="page-item" :class="{ disabled: ingredientPagination.page === ingredientPagination.total_pages }"><a class="page-link" href="#" @click.prevent="changePage(ingredientPagination.total_pages)" title="Last Page"><i class="bi bi-chevron-bar-right"></i></a></li><li class="page-item disabled ms-2"><span class="page-link">Page {{ ingredientPagination.page }} of {{ ingredientPagination.total_pages }} ({{ingredientPagination.total_items}} items)</span></li></ul>
                </nav>
                <div class="table-responsive">
                    <p v-if="!ingredients || ingredients.length === 0 && !ingredientSearch.trim()" class="text-center text-muted py-3">No ingredients found. Add one or import data.</p>
                    <p v-if="!ingredients || ingredients.length === 0 && ingredientSearch.trim()" class="text-center text-muted py-3">No ingredients match: "{{ ingredientSearch }}".</p>
                    <table v-if="ingredients && ingredients.length > 0" class="table table-striped table-hover resizable-table table-bordered"><thead class="sticky-thead"><tr><th style="width:40px;vertical-align:middle;"><input type="checkbox" class="form-check-input" @change="toggleSelectAllIngredients" :checked="sortedIngredients.length > 0 && selectedIngredientIds.length === sortedIngredients.length" :indeterminate="selectedIngredientIds.length > 0 && selectedIngredientIds.length < sortedIngredients.length"></th><th class="resizable sortable-header" @mousedown="startResize($event,0)" @click="sortIngredients('name')">Name <i class="bi" :class="getSortIcon('name')"></i></th><th class="resizable sortable-header" @mousedown="startResize($event,1)" @click="sortIngredients('stock_quantity')">Amount / Unit <i class="bi" :class="getSortIcon('stock_quantity')"></i></th><th class="resizable sortable-header" @mousedown="startResize($event,2)" @click="sortIngredients('categoriesDisplay')">Categories <i class="bi" :class="getSortIcon('categoriesDisplay')"></i></th><th class="resizable sortable-header" @mousedown="startResize($event,3)" @click="sortIngredients('notes')">Notes <i class="bi" :class="getSortIcon('notes')"></i></th><th class="actions-column" style="width:130px;">Actions</th></tr></thead>
                        <tbody>
                            <tr v-for="ingredient in sortedIngredients" :key="ingredient.id" :id="'ingredient-row-' + ingredient.id" :class="{'table-active': selectedIngredientIds.includes(ingredient.id), 'table-info': ingredient.id === editingIngredientId && (ingredient.isEditing || ingredient.isEditingAmount) }">
                                <td><input type="checkbox" class="form-check-input" :value="ingredient.id" v-model="selectedIngredientIds"></td>
                                <td @dblclick="!(ingredient.isEditing || ingredient.isEditingAmount) && startEditing(ingredient)"><input v-if="ingredient.isEditing" type="text" class="inline-edit-input" v-model="ingredient.editBuffer.name" @keyup.enter="saveInlineEdit(ingredient)" @keyup.esc="cancelEditing(ingredient)" v-focus> <span v-else>{{ ingredient.name }}</span></td>
                                <td @dblclick="!(ingredient.isEditing || ingredient.isEditingAmount) && startEditingAmount(ingredient)"><div v-if="ingredient.isEditingAmount"><input type="number" step="any" class="inline-edit-input d-inline-block" style="width:60%;" v-model.number="ingredient.editBuffer.stock_quantity" @keyup.enter="saveInlineEdit(ingredient)" @keyup.esc="cancelEditing(ingredient)" v-focus><select class="form-select-sm d-inline-block" style="width:35%;" v-model="ingredient.editBuffer.unit_of_measurement"><option value="g">g</option><option value="mL">mL</option><option value="oz">oz</option><option value="drops">drops</option></select></div> <div v-else v-html="displayAmountAndUnit(ingredient)"></div></td>
                                <td @dblclick="!(ingredient.isEditing || ingredient.isEditingAmount) && startEditing(ingredient)"><div v-if="ingredient.isEditing" style="min-width:150px;"><select multiple class="form-select form-select-sm" v-model="ingredient.editBuffer.category_ids" size="3"><option v-for="cat in categories" :value="cat.id" :key="cat.id">{{ cat.name }}</option></select><small class="text-muted d-block mt-1">Ctrl/Cmd + click</small></div> <span v-else><span v-for="category in ingredient.categories" :key="category.id" class="badge bg-secondary me-1 mb-1 category-tag">{{ category.name }}</span><span v-if="!ingredient.categories || ingredient.categories.length === 0" class="text-muted small">None</span></span></td>
                                <td @dblclick="!(ingredient.isEditing || ingredient.isEditingAmount) && startEditing(ingredient)"><input v-if="ingredient.isEditing" type="text" class="inline-edit-input" v-model="ingredient.editBuffer.notes" @keyup.enter="saveInlineEdit(ingredient)" @keyup.esc="cancelEditing(ingredient)"> <span v-else class="notes-cell" :title="formatNotes(ingredient.notes)">{{ formatNotes(ingredient.notes) }}</span></td>
                                <td class="actions-column"><div v-if="ingredient.isEditing || ingredient.isEditingAmount" class="btn-group btn-group-sm action-buttons-inline-edit"><button class="btn btn-success btn-sm" @click="saveInlineEdit(ingredient)" title="Save"><i class="bi bi-check-lg"></i></button><button class="btn btn-warning btn-sm" @click="cancelEditing(ingredient)" title="Cancel"><i class="bi bi-x-lg"></i></button></div><div v-else class="btn-group btn-group-sm"><button class="btn btn-outline-primary btn-sm" @click="viewIngredient(ingredient.id)" title="View Details"><i class="bi bi-eye"></i></button><button class="btn btn-outline-secondary btn-sm" @click="startEditing(ingredient)" title="Edit In-place"><i class="bi bi-pencil-square"></i></button><button class="btn btn-outline-danger btn-sm" @click="deleteIngredient(ingredient.id)" title="Delete"><i class="bi bi-trash"></i></button></div></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </main>

            <main class="main-content" v-if="currentMainView === 'formulas'">
                <div class="main-content-header">
                    <h2>Formulas</h2>
                    <div class="filters-toolbar">
                        <div class="input-group input-group-sm me-2 flex-grow-1">
                            <input type="text" class="form-control" placeholder="Search formulas..." 
                                   v-model="formulaSearch" @keyup.enter="triggerFormulaSearch()">
                            <button class="btn btn-outline-secondary" type="button" @click="triggerFormulaSearch()"><i class="bi bi-search"></i></button>
                        </div>
                        <button class="btn btn-primary btn-sm" @click="openFormulaModal('add')">
                            <i class="bi bi-plus-circle"></i> Add New Formula
                        </button>
                    </div>
                </div>
            
                <div class="table-responsive mt-3" v-if="formulas.length > 0">
                    <table class="table table-striped table-hover">
                        <thead class="sticky-thead"> 
                            <tr>
                                <th>Name</th>
                                <th>Creator</th>
                                <th>Version</th>
                                <th class="text-center">Ingredients</th>
                                <th class="text-end">Total Cost</th>
                                <th>Last Updated</th>
                                <th class="actions-column-formulas">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="formula in formulas" :key="formula.id">
                                <td>{{ formula.name }} <span v-if="formula.is_draft" class="badge bg-warning text-dark">Draft</span></td>
                                <td>{{ formula.creator || 'N/A' }}</td>
                                <td>{{ formula.version }}</td>
                                <td class="text-center">{{ formula.ingredient_count }}</td>
                                <td class="text-end">{{ formatCurrency(formula.total_cost) }}</td>
                                <td>{{ formatDate(formula.updated_at) }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" @click="viewFormulaDetails(formula)" title="View"><i class="bi bi-eye"></i></button>
                                        <button class="btn btn-outline-secondary" @click="openFormulaModal('edit', formula)" title="Edit"><i class="bi bi-pencil-square"></i></button>
                                        <button class="btn btn-outline-info" @click="confirmDuplicateFormula(formula.id)" title="Duplicate"><i class="bi bi-copy"></i></button>
                                        <button class="btn btn-outline-danger" @click="confirmDeleteFormula(formula.id)" title="Delete"><i class="bi bi-trash"></i></button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <p v-else-if="!formulas.length && formulaSearch.trim()" class="text-center text-muted py-3">No formulas match: "{{formulaSearch}}"</p>
                <p v-else class="text-center text-muted py-3">No formulas created yet. Click "Add New Formula" to start.</p>
            
                <nav aria-label="Formula pagination" v-if="formulaPagination.total_pages > 1" class="my-3">
                    <ul class="pagination justify-content-center pagination-sm">
                        <li class="page-item" :class="{ disabled: formulaPagination.page === 1 }"><a class="page-link" href="#" @click.prevent="changeFormulaPage(1)" title="First Page"><i class="bi bi-chevron-bar-left"></i></a></li>
                        <li class="page-item" :class="{ disabled: formulaPagination.page === 1 }"><a class="page-link" href="#" @click.prevent="changeFormulaPage(formulaPagination.page - 1)" title="Previous Page"><i class="bi bi-chevron-left"></i></a></li>
                        <li v-for="pageNumber in formulaPageNumbers" :key="pageNumber" class="page-item" :class="{ active: pageNumber === formulaPagination.page }">
                            <a class="page-link" href="#" @click.prevent="changeFormulaPage(pageNumber)">{{ pageNumber }}</a>
                        </li>
                        <li class="page-item" :class="{ disabled: formulaPagination.page === formulaPagination.total_pages }"><a class="page-link" href="#" @click.prevent="changeFormulaPage(formulaPagination.page + 1)" title="Next Page"><i class="bi bi-chevron-right"></i></a></li>
                        <li class="page-item" :class="{ disabled: formulaPagination.page === formulaPagination.total_pages }"><a class="page-link" href="#" @click.prevent="changeFormulaPage(formulaPagination.total_pages)" title="Last Page"><i class="bi bi-chevron-bar-right"></i></a></li>
                         <li class="page-item disabled ms-2"><span class="page-link">Page {{ formulaPagination.page }} of {{ formulaPagination.total_pages }} ({{formulaPagination.total_items}} formulas)</span></li>
                    </ul>
                </nav>
            </main>

            <aside class="right-sidebar">
                <div class="sidebar-panel"><h5 class="mb-3">Data Management</h5><div class="d-grid gap-2">
                    <button class="btn btn-outline-primary btn-sm" @click="navigateToManageCategories"><i class="bi bi-tags-fill me-1"></i> Manage Categories</button>
                    <button class="btn btn-outline-secondary btn-sm" @click="exportData('json')"><i class="bi bi-filetype-json me-1"></i> Export Ingredients to JSON</button>
                    <button class="btn btn-outline-info btn-sm" @click="navigateToImportData"><i class="bi bi-upload me-1"></i> Import Ingredients</button>
                    <hr>
                    <div v-if="currentMainView === 'ingredients'">
                        <button class="btn btn-outline-warning btn-sm mb-2 w-100" @click="batchUpdateNotes" :disabled="selectedIngredientIds.length === 0"><i class="bi bi-pencil-fill me-1"></i> Update Notes ({{ selectedIngredientIds.length }})</button>
                        <button class="btn btn-outline-warning btn-sm mb-2 w-100" @click="batchUpdateCategories" :disabled="selectedIngredientIds.length === 0"><i class="bi bi-tag-fill me-1"></i> Update Categories ({{ selectedIngredientIds.length }})</button>
                        <button class="btn btn-danger btn-sm w-100" @click="promptDeleteSelectedIngredients" :disabled="selectedIngredientIds.length === 0"><i class="bi bi-trash2-fill me-1"></i> Delete Selected ({{ selectedIngredientIds.length }})</button>
                        <button class="btn btn-danger btn-sm mt-2 w-100" @click="promptDeleteAllIngredients" :disabled="!ingredients || ingredients.length === 0"><i class="bi bi-trash3-fill me-1"></i> Delete All Ingredients</button>
                    </div>
                     <p v-if="currentMainView === 'formulas'" class="text-muted small text-center">Batch actions for formulas can be added here.</p>
                    <hr class="my-3">
                    <button class="btn btn-danger w-100" @click="promptResetCategoriesToDefaults"><i class="bi bi-exclamation-triangle-fill me-1"></i> Reset Categories to Defaults</button>
                    <small class="text-muted d-block text-center mt-1">Warning: Deletes all current categories and assignments!</small>
                </div></div>
                <div class="sidebar-panel mt-4" v-if="showContextualAIPanel">
                    <h5 class="mb-3">AI Assist <button type="button" class="btn-close btn-sm float-end" @click="hideAIContextPanel"></button></h5>
                    <p class="small text-muted" v-if="contextualAIItem">For: {{ contextualAIItem.name }}</p>
                    <textarea class="form-control form-control-sm mb-2" rows="3" placeholder="Ask AI about this item..."></textarea>
                    <button class="btn btn-info btn-sm w-100">Get Suggestion</button>
                </div>
            </aside>
            </div> <button class="fab-ai" @click="toggleGlobalAIChat" title="Open AI Chat"><i class="bi bi-robot"></i></button>
        
        <div class="modal fade" id="globalAiChatModal" tabindex="-1" aria-labelledby="globalAiChatModalLabel" aria-hidden="true"> <div class="modal-dialog modal-lg"> <div class="modal-content"> <div class="modal-header"><h5 class="modal-title" id="globalAiChatModalLabel">AI Formulation Assistant</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div> <div class="modal-body"><p>AI Chat interface placeholder...</p><textarea class="form-control" rows="5" placeholder="Ask anything about perfumery..."></textarea></div> <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button type="button" class="btn btn-primary">Send to AI</button></div> </div> </div> </div>
        
        <div class="modal fade" id="viewIngredientModal" tabindex="-1" aria-labelledby="viewIngredientModalLabel" aria-hidden="true"> <div class="modal-dialog modal-lg"> <div class="modal-content"> <div class="modal-header"><h5 class="modal-title" id="viewIngredientModalLabel">Ingredient Details</h5><button type="button" class="btn-close" @click="closeModal('viewIngredientModal')" aria-label="Close"></button></div> <div class="modal-body" v-if="viewedIngredient"><h4>{{ viewedIngredient.name }}</h4><hr><p><strong>Supplier:</strong> {{ viewedIngredient.supplier || 'N/A' }}</p><p><strong>Stock:</strong> <span v-html="displayAmountAndUnit(viewedIngredient)"></span></p><p><strong>Cost/Unit:</strong> {{ formatCurrency(viewedIngredient.cost_per_unit) || 'N/A' }}</p><p><strong>Description:</strong><br><span style="white-space: pre-wrap;">{{ viewedIngredient.description || 'N/A' }}</span></p><p><strong>Categories:</strong> <span v-if="viewedIngredient.categories && viewedIngredient.categories.length"><span v-for="cat in viewedIngredient.categories" :key="cat.id" class="badge bg-info me-1">{{ cat.name }}</span></span><span v-else class="text-muted">None</span></p><hr><small class="text-muted">Updated: {{ formatDate(viewedIngredient.last_updated) }} | Added: {{ formatDate(viewedIngredient.date_added) }}</small></div> <div class="modal-footer"><button type="button" class="btn btn-outline-secondary" @click="startEditing(viewedIngredient); closeModal('viewIngredientModal');" v-if="viewedIngredient">Edit In-place</button><button type="button" class="btn btn-primary" @click="closeModal('viewIngredientModal')">Close</button></div> </div> </div> </div>
        
        <div class="modal fade" id="batchCategoryModal" tabindex="-1" aria-labelledby="batchCategoryModalLabel" aria-hidden="true"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"><h5 class="modal-title" id="batchCategoryModalLabel">Batch Update Categories</h5><button type="button" class="btn-close" @click="closeModal('batchCategoryModal')" aria-label="Close"></button></div> <div class="modal-body"><p>Apply to <strong>{{ selectedIngredientIds.length }}</strong> selected items. Existing categories will be replaced.</p><div class="mb-3"><label for="batchCategoriesSelect" class="form-label">Categories</label><select multiple class="form-select" size="8" id="batchCategoriesSelect" v-model="batchCategoriesToApply"><option v-for="category in categories" :value="category.id" :key="category.id">{{ category.name }}</option></select><small class="form-text text-muted">Ctrl/Cmd+click. Deselect all to remove categories.</small></div></div> <div class="modal-footer"><button type="button" class="btn btn-secondary" @click="closeModal('batchCategoryModal')">Cancel</button><button type="button" class="btn btn-primary" @click="applyBatchCategoryUpdate">Apply Categories</button></div> </div> </div> </div>
        
        <div class="modal fade" id="manageCategoriesModal" tabindex="-1" aria-labelledby="manageCategoriesModalLabel" aria-hidden="true"> <div class="modal-dialog modal-lg modal-dialog-scrollable"> <div class="modal-content"> <div class="modal-header"><h5 class="modal-title" id="manageCategoriesModalLabel">Manage Categories</h5><button type="button" class="btn-close" @click="closeModal('manageCategoriesModal')" aria-label="Close"></button></div> <div class="modal-body"> <div class="mb-3"><button class="btn btn-primary btn-sm" @click="showAddCategoryInlineForm"><i class="bi bi-plus-circle"></i> Add New Category</button></div> <div v-if="showAddCategoryForm" class="card mb-3 shadow-sm"> <div class="card-body"><h6 class="card-title">New Category Details</h6><form @submit.prevent="saveNewInlineCategory"><div class="row"><div class="col-md-6 mb-2"><label for="newCatName" class="form-label form-label-sm">Name <span class="text-danger">*</span></label><input type="text" class="form-control form-control-sm" id="newCatName" v-model="newCategory.name" required></div><div class="col-md-6 mb-2"><label for="newCatParent" class="form-label form-label-sm">Parent Category</label><select class="form-select form-select-sm" id="newCatParent" v-model="newCategory.parent_id"><option :value="null">-- No Parent --</option><option v-for="cat in categories.filter(c => c.id !== newCategory.id)" :value="cat.id" :key="cat.id">{{ cat.name }}</option></select></div></div><div class="mb-2"><label for="newCatDesc" class="form-label form-label-sm">Description</label><textarea class="form-control form-control-sm" id="newCatDesc" rows="2" v-model="newCategory.description"></textarea></div><div class="text-end"><button type="button" class="btn btn-outline-secondary btn-sm me-2" @click="cancelAddCategoryInline">Cancel</button><button type="submit" class="btn btn-success btn-sm">Save Category</button></div></form></div></div> <div class="table-responsive"><table class="table table-sm table-hover"><thead><tr><th>Name</th><th>Description</th><th>Parent</th><th class="text-center">Ingredients</th><th style="width: 150px;" class="text-center">Actions</th></tr></thead><tbody><tr v-for="category in categories" :key="category.id" :class="{'table-info': editingCategoryId === category.id}"><td><input v-if="editingCategoryId === category.id" type="text" class="form-control form-control-sm" v-model="categoryEditBuffer.name" @keyup.enter="saveCategoryEdit(category)" @keyup.esc="cancelCategoryEdit()"> <span v-else>{{ category.name }}</span></td><td><textarea v-if="editingCategoryId === category.id" class="form-control form-control-sm" rows="1" v-model="categoryEditBuffer.description" @keyup.enter.prevent="saveCategoryEdit(category)" @keyup.esc="cancelCategoryEdit()"></textarea> <span v-else class="notes-cell" :title="category.description">{{ category.description }}</span></td><td><select v-if="editingCategoryId === category.id" class="form-select form-select-sm" v-model="categoryEditBuffer.parent_id"><option :value="null">-- No Parent --</option><option v-for="parentCatOpt in categories.filter(c => c.id !== category.id)" :value="parentCatOpt.id" :key="parentCatOpt.id">{{ parentCatOpt.name }}</option></select> <span v-else>{{ getCategoryNameById(category.parent_id) || 'None' }}</span></td><td class="text-center"><span class="badge rounded-pill" :class="category.ingredient_count > 0 ? 'bg-primary' : 'bg-secondary'"> {{ category.ingredient_count || 0 }} </span></td><td class="text-center"><div v-if="editingCategoryId === category.id" class="btn-group btn-group-sm"><button class="btn btn-success btn-sm" @click="saveCategoryEdit(category)" title="Save"><i class="bi bi-check-lg"></i></button><button class="btn btn-warning btn-sm" @click="cancelCategoryEdit()" title="Cancel"><i class="bi bi-x-lg"></i></button></div><div v-else class="btn-group btn-group-sm"><button class="btn btn-outline-secondary btn-sm" @click="startCategoryEdit(category)" title="Edit"><i class="bi bi-pencil-square"></i></button><button class="btn btn-outline-danger btn-sm" @click="confirmDeleteCategory(category.id)" title="Delete" :disabled="category.ingredient_count > 0"><i class="bi bi-trash"></i></button></div></td></tr><tr v-if="!categories || categories.length === 0"><td colspan="5" class="text-center text-muted py-3">No categories found.</td></tr></tbody></table></div> </div> <div class="modal-footer"><button type="button" class="btn btn-secondary" @click="closeModal('manageCategoriesModal')">Close</button></div> </div> </div> </div>
        
        <div class="modal fade" id="importDataModal" tabindex="-1" aria-labelledby="importDataModalLabel" aria-hidden="true"> <div class="modal-dialog modal-xl modal-dialog-scrollable"> <div class="modal-content"> <div class="modal-header"><h5 class="modal-title" id="importDataModalLabel">Import Data</h5><button type="button" class="btn-close" @click="closeModal('importDataModal')" aria-label="Close"></button></div> <div class="modal-body"> <p>Select CSV/JSON file. System will analyze it.</p><div class="mb-3"><label for="importFileTypeModal" class="form-label">1. Select Import Type:</label><select class="form-select" id="importFileTypeModal" v-model="importType"><option value="ingredients">Ingredients</option></select></div><div class="mb-3"><label for="importFileInputModal" class="form-label">2. Upload File (.csv, .json):</label><input class="form-control" type="file" id="importFileInputModal" @change="handleFileUpload" accept=".csv,.json" :disabled="isAnalyzingFile"></div><div v-if="importFileObject" class="mb-3"><button class="btn btn-primary" @click="processImport" :disabled="!importFileObject||isAnalyzingFile||!fileAnalyzedSuccessfully"><span v-if="isAnalyzingFile"><span class="spinner-border spinner-border-sm"></span> Analyzing...</span><span v-else>3. Process Import</span></button></div> <div v-if="importStatus" class="mt-3 alert" :class="importSuccess?'alert-success':(importErrors.length>0||(importFileObject&&!fileAnalyzedSuccessfully&&!isAnalyzingFile)?'alert-danger':'alert-info')"><p class="mb-0" v-html="importStatus"></p></div> <div v-if="importErrors.length > 0" class="mt-3 alert alert-warning"><h6>Errors:</h6><ul style="max-height:150px;overflow-y:auto;"><li v-for="(err,idx) in importErrors" :key="idx" v-html="err"></li></ul></div> <div v-if="categoryWarnings && categoryWarnings.length > 0" class="mt-3 alert alert-info"><h6>Category Warnings:</h6><ul style="max-height:150px;overflow-y:auto;"><li v-for="(warn,idx) in categoryWarnings" :key="'w'+idx" v-html="warn"></li></ul></div> <div v-if="fileAnalyzedSuccessfully&&importAnalysis" class="mt-4 p-3 border rounded bg-light"><h5>Analysis Results:</h5><p><strong>Format:</strong> {{importAnalysis.format}}</p><p v-if="importAnalysis.data_path"><strong>Data Path:</strong> <code>{{importAnalysis.data_path}}</code></p><p><strong>Items Found:</strong> <span class="fw-bold">{{importAnalysis.item_count}}</span></p><p><strong>Fields ({{importAnalysis.fields?importAnalysis.fields.length:0}} detected):</strong> <span v-if="importAnalysis.fields&&importAnalysis.fields.length"><span v-for="(f,ix) in importAnalysis.fields" :key="ix" class="badge bg-secondary me-1 mb-1">{{f}}</span></span><span v-else class="text-muted">None.</span></p> <h6 class="mt-3">Mapping (Review/Adjust):</h6><p class="small text-muted">Match Source (File) to Target (Application).</p><div v-if="importAnalysis.mapping_suggestion&&Object.keys(importAnalysis.mapping_suggestion).length" class="table-responsive" style="max-height:400px;overflow-y:auto;"><table class="table table-sm table-bordered"><thead><tr><th>Target Field</th><th>Source Field (File)</th></tr></thead><tbody><tr v-for="(sugg,tgt) in importAnalysis.mapping_suggestion" :key="tgt"><td><label :for="'map-mdl-'+tgt" class="form-label mb-0">{{formatFieldName(tgt.replace('_source_key_',' (Cat. Source)'))}}</label></td><td><select class="form-select form-select-sm" :id="'map-mdl-'+tgt" v-model="importMapping[tgt]"><option :value="null">-- Do not map --</option><option v-for="ff in importAnalysis.fields" :key="ff" :value="ff">{{ff}}</option></select><small v-if="sugg&&importMapping[tgt]!==sugg&&importMapping[tgt]!==null" class="text-muted d-block mt-1">Suggested: {{sugg}}</small></td></tr></tbody></table></div><p v-else class="text-muted">No mapping suggestions.</p> <h6 class="mt-3">Sample Data (First {{importAnalysis.sample_data?importAnalysis.sample_data.length:0}}):</h6><div v-if="importAnalysis.sample_data&&importAnalysis.sample_data.length" class="table-responsive" style="max-height:300px;overflow-y:auto;"><table class="table table-sm table-striped"><thead><tr><th v-for="f in importAnalysis.fields" :key="f">{{f}}</th></tr></thead><tbody><tr v-for="(it,itx) in importAnalysis.sample_data" :key="itx"><td v-for="f in importAnalysis.fields" :key="f" style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" :title="it[f]">{{it[f]}}</td></tr></tbody></table></div><p v-else class="text-muted">No sample data.</p></div> </div> <div class="modal-footer"><button type="button" class="btn btn-secondary" @click="closeModal('importDataModal')">Close</button></div> </div> </div> </div>

        <div class="modal fade" id="formulaModal" tabindex="-1" aria-labelledby="formulaModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-scrollable">
                <div class="modal-content"> 
                    <div class="modal-header">
                        <h5 class="modal-title" id="formulaModalLabel">{{ formulaModalMode === 'add' ? 'Add New' : 'Edit' }} Formula</h5>
                        <button type="button" class="btn-close" @click="closeFormulaModal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="saveFormula">
                            <div class="p-3 mb-3 border rounded bg-opacity-10" :class="isDarkMode ? 'bg-dark border-secondary' : 'bg-light border-light-subtle'">
                                <h5 class="mb-3"><i class="bi bi-robot"></i> AI Formula Generation / Adjustment</h5>
                                <div class="mb-3">
                                    <label for="aiFormulaUserDescription" class="form-label">Describe the scent or adjustment:</label>
                                    <textarea class="form-control" id="aiFormulaUserDescription" rows="3" v-model="aiFormulaUserDescription" placeholder="e.g., Create a fresh citrus scent with woody undertones. OR Adjust current formula to 30mL total. OR Make current formula more floral."></textarea>
                                </div>
                                <div class="row g-2 mb-3 align-items-end">
                                    <div class="col-md-4">
                                        <label for="aiSelectedService" class="form-label-sm">AI Service:</label>
                                        <select id="aiSelectedService" class="form-select form-select-sm" v-model="aiSelectedService">
                                            <option value="gemini">Gemini</option>
                                            <option value="openrouter">OpenRouter</option>
                                            <option value="claude">Claude</option>
                                        </select>
                                    </div>
                                    <div class="col-md-5">
                                        <label for="aiSelectedModel" class="form-label-sm">Model:</label>
                                        <select id="aiSelectedModel" class="form-select form-select-sm" v-model="aiSelectedModel" :disabled="!currentAIServiceModels.length">
                                            <option v-if="!currentAIServiceModels.length" value="" disabled>Select service & API key</option>
                                            <option v-for="model in currentAIServiceModels" :value="model.id" :key="model.id">{{ model.name }}</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="aiTargetTotalQuantity" class="form-label-sm">Target Qty (Opt.):</label>
                                        <input type="number" step="any" class="form-control form-control-sm" id="aiTargetTotalQuantity" v-model.number="aiTargetTotalQuantity" placeholder="e.g., 30">
                                    </div>
                                </div>
                                <button type="button" class="btn btn-info btn-sm w-100" @click="generateAIFormula" :disabled="isLoadingAIFormula || !aiFormulaUserDescription.trim() || !aiSelectedModel">
                                    <span v-if="isLoadingAIFormula" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                    <i v-else class="bi bi-stars"></i>
                                    Generate with AI
                                </button>
                                <div v-if="aiFormulaError" class="alert alert-danger alert-sm mt-2 py-1 px-2">{{ aiFormulaError }}</div>
                            
                                <div v-if="aiGeneratedFormulaIngredients.length > 0" class="mt-3">
                                    <h6>AI Suggested Ingredients:</h6>
                                    <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                                        <table class="table table-sm table-hover table-xs"> <thead>
                                                <tr>
                                                    <th>Name (from AI)</th>
                                                    <th class="text-end">Qty</th>
                                                    <th>Unit</th>
                                                    <th>Status</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr v-for="(aiIng, index) in aiGeneratedFormulaIngredients" :key="'ai-'+index" :class="{'table-success opacity-75': aiIng.used, 'table-warning': aiIng.needs_mapping && !aiIng.used}">
                                                    <td>
                                                        {{ aiIng.ingredient_name_from_ai }}
                                                        <small v-if="aiIng.needs_mapping && !aiIng.used" class="d-block text-danger">(Not in inventory!)</small>
                                                        <small v-else-if="!aiIng.needs_mapping && !aiIng.used" class="d-block text-success">(Matched: {{aiIng.name}})</small>
                                                    </td>
                                                    <td class="text-end">{{ aiIng.quantity }}</td>
                                                    <td>{{ aiIng.unit }}</td>
                                                    <td><span v-if="aiIng.used" class="badge bg-secondary">Used</span></td>
                                                    <td>
                                                        <button v-if="!aiIng.used && aiIng.ingredient_id" type="button" class="btn btn-outline-success btn-xs py-0 px-1" @click="useAIGeneratedIngredient(aiIng, index)" title="Add to current formula">
                                                            <i class="bi bi-arrow-down-circle"></i> Use
                                                        </button>
                                                         <span v-if="!aiIng.used && !aiIng.ingredient_id" class="text-muted small">Map</span>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="mt-2 d-flex justify-content-between">
                                        <button type="button" class="btn btn-outline-primary btn-sm" @click="loadAllAIGeneratedIngredients" 
                                                :disabled="!aiGeneratedFormulaIngredients.some(ing => !ing.used && ing.ingredient_id)">
                                            <i class="bi bi-arrow-down-circle-fill"></i> Use All Mapped
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" @click="clearAIGeneratedFormula">
                                            <i class="bi bi-x-circle"></i> Clear Suggestions
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <hr> 

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="formulaNameModal" class="form-label">Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="formulaNameModal" v-model="currentFormula.name" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="formulaCreatorModal" class="form-label">Creator</label>
                                    <input type="text" class="form-control" id="formulaCreatorModal" v-model="currentFormula.creator">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="formulaDescriptionModal" class="form-label">Description</label>
                                <textarea class="form-control" id="formulaDescriptionModal" rows="2" v-model="currentFormula.description"></textarea>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="formulaVersionModal" class="form-label">Version</label>
                                    <input type="text" class="form-control" id="formulaVersionModal" v-model="currentFormula.version">
                                </div>
                                <div class="col-md-6 mb-3 align-self-center">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="formulaIsDraftModal" v-model="currentFormula.is_draft">
                                        <label class="form-check-label" for="formulaIsDraftModal">Is Draft</label>
                                    </div>
                                </div>
                            </div>
                             <hr>
                            <h6>Ingredients</h6>
                            <div v-for="(item, index) in currentFormula.ingredients" :key="index" class="row align-items-center mb-2 p-2 border rounded bg-light-subtle"> 
                                <div class="col-md-3"> 
                                    <label class="form-label-sm">Ingredient <span class="text-danger">*</span></label>
                                    <select class="form-select form-select-sm" v-model="item.ingredient_id" @change="onIngredientSelectInFormula($event, item)" required>
                                        <option :value="null" disabled>Select Ingredient</option>
                                        <option v-for="ing in allIngredientsForSelection" :value="ing.id" :key="ing.id">{{ ing.name }}</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label-sm">Quantity <span class="text-danger">*</span></label>
                                    <input type="number" step="any" class="form-control form-control-sm" v-model.number="item.quantity" @input="recalculateFormulaPercentages" required min="0">
                                </div>
                                <div class="col-md-2"> 
                                    <label class="form-label-sm">Unit</label>
                                     <select class="form-select form-select-sm" v-model="item.unit">
                                        <option v-for="unitOption in formulaIngredientUnits" :value="unitOption" :key="unitOption">
                                            {{ unitOption }}
                                        </option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label-sm">Percentage</label>
                                    <input type="text" class="form-control form-control-sm" :value="item.percentage ? item.percentage.toFixed(2) + '%' : '0%'" readonly>
                                </div>
                                 <div class="col-md-2">
                                    <label class="form-label-sm">Notes</label>
                                    <input type="text" class="form-control form-control-sm" v-model="item.notes">
                                </div>
                                <div class="col-md-1 text-end align-self-end">
                                    <button type="button" class="btn btn-danger btn-sm" @click="removeIngredientFromCurrentFormula(index)" title="Remove Ingredient">&times;</button>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-success btn-sm mt-2" @click="addIngredientToCurrentFormula"><i class="bi bi-plus"></i> Add Ingredient Row</button>
                            
                            <div class="mt-3 p-3 bg-light rounded"> 
                                <div class="row">
                                    <div class="col"><strong>Total Quantity:</strong> {{ currentFormulaTotalQuantity.toFixed(3) }}</div>
                                    <div class="col"><strong>Estimated Total Cost:</strong> {{ formatCurrency(currentFormulaTotalCost) }}</div>
                                </div>
                            </div>
        
                            <div class="mb-3 mt-3">
                                <label for="formulaNotesModal" class="form-label">Overall Formula Notes</label>
                                <textarea class="form-control" id="formulaNotesModal" rows="3" v-model="currentFormula.notes"></textarea>
                            </div>
        
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @click="closeFormulaModal">Cancel</button>
                        <button type="button" class="btn btn-primary" @click="saveFormula">Save Formula</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="modal fade" id="viewFormulaModal" tabindex="-1" aria-labelledby="viewFormulaModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="viewFormulaModalLabel">Formula Details</h5>
                        <button type="button" class="btn-close" @click="closeViewFormulaModal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" v-if="viewedFormula">
                        <h4>{{ viewedFormula.name }} <span v-if="viewedFormula.is_draft" class="badge bg-warning text-dark fs-6 ms-2">Draft</span></h4>
                        <p class="mb-1"><strong>Creator:</strong> {{ viewedFormula.creator || 'N/A' }} | <strong>Version:</strong> {{ viewedFormula.version || 'N/A' }}</p>
                        <p><strong>Description:</strong><br><span style="white-space: pre-wrap;">{{ viewedFormula.description || 'N/A' }}</span></p>
                         <hr>
                        <h6>Ingredients (<span v-if="viewedFormula.ingredients">{{ viewedFormula.ingredients.length }}</span><span v-else>0</span>)</h6>
                        <div v-if="viewedFormula.ingredients && viewedFormula.ingredients.length > 0" class="table-responsive">
                            <table class="table table-sm table-bordered table-striped">
                                <thead class="table-light"> 
                                    <tr>
                                        <th>Name</th>
                                        <th class="text-end">Quantity</th>
                                        <th>Unit</th>
                                        <th class="text-end">Percentage</th>
                                        <th class="text-end">Est. Cost</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="item in viewedFormula.ingredients" :key="item.id"> 
                                        <td>{{ item.name }}</td>
                                        <td class="text-end">{{ item.quantity != null ? item.quantity.toFixed(3) : '0.000' }}</td>
                                        <td>{{ item.unit }}</td>
                                        <td class="text-end">{{ item.percentage != null ? item.percentage.toFixed(2) + '%' : '0.00%' }}</td>
                                        <td class="text-end">{{ formatCurrency(item.cost) }}</td>
                                        <td style="white-space: pre-wrap;">{{ item.notes }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <p v-else class="text-muted fst-italic">No ingredients in this formula.</p>
        
                        <div class="mt-3 p-3 bg-light rounded"> 
                            <div class="row">
                                <div class="col"><strong>Total Quantity:</strong> {{ viewedFormula.total_quantity != null ? viewedFormula.total_quantity.toFixed(3) : '0.000' }}</div>
                                <div class="col"><strong>Total Cost:</strong> {{ formatCurrency(viewedFormula.total_cost) }}</div>
                            </div>
                        </div>
        
                        <div class="mt-3">
                            <strong>Overall Formula Notes:</strong>
                            <p style="white-space: pre-wrap;" class="p-2 border rounded bg-light-subtle mt-1">{{ viewedFormula.notes || 'N/A' }}</p> 
                        </div>
                        <hr>
                        <small class="text-muted d-block">Created: {{ formatDate(viewedFormula.created_at) }}</small>
                        <small class="text-muted d-block">Last Updated: {{ formatDate(viewedFormula.updated_at) }}</small>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" @click="openFormulaModal('edit', viewedFormula); closeViewFormulaModal();">Edit Formula</button>
                        <button type="button" class="btn btn-primary" @click="closeViewFormulaModal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="apiSettingsModal" tabindex="-1" aria-labelledby="apiSettingsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="apiSettingsModalLabel"><i class="bi bi-key-fill"></i> AI Service API Keys</h5>
                        <button type="button" class="btn-close" @click="closeApiSettingsModal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p class="small text-muted">API keys are stored in your browser's local storage. They are not sent to our server except when making direct calls to the AI services on your behalf.</p>
                        
                        <div class="mb-3">
                            <label for="apiKeyOpenRouter" class="form-label">OpenRouter API Key:</label>
                            <div class="input-group">
                                <input :type="showApiKeys.openrouter ? 'text' : 'password'" class="form-control form-control-sm" id="apiKeyOpenRouter" v-model.trim="apiKeys.openrouter" placeholder="Enter your OpenRouter API Key">
                                <button class="btn btn-outline-secondary btn-sm" type="button" @click="showApiKeys.openrouter = !showApiKeys.openrouter">
                                    <i class="bi" :class="showApiKeys.openrouter ? 'bi-eye-slash' : 'bi-eye'"></i>
                                </button>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="apiKeyGemini" class="form-label">Google AI (Gemini) API Key:</label>
                             <div class="input-group">
                                <input :type="showApiKeys.gemini ? 'text' : 'password'" class="form-control form-control-sm" id="apiKeyGemini" v-model.trim="apiKeys.gemini" placeholder="Enter your Gemini API Key">
                                <button class="btn btn-outline-secondary btn-sm" type="button" @click="showApiKeys.gemini = !showApiKeys.gemini">
                                    <i class="bi" :class="showApiKeys.gemini ? 'bi-eye-slash' : 'bi-eye'"></i>
                                </button>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="apiKeyClaude" class="form-label">Anthropic (Claude) API Key:</label>
                            <div class="input-group">
                                <input :type="showApiKeys.claude ? 'text' : 'password'" class="form-control form-control-sm" id="apiKeyClaude" v-model.trim="apiKeys.claude" placeholder="Enter your Claude API Key">
                                <button class="btn btn-outline-secondary btn-sm" type="button" @click="showApiKeys.claude = !showApiKeys.claude">
                                    <i class="bi" :class="showApiKeys.claude ? 'bi-eye-slash' : 'bi-eye'"></i>
                                </button>
                            </div>
                        </div>
                        <div v-if="apiKeySaveStatus" class="alert alert-success alert-sm py-1 px-2 mt-2">{{ apiKeySaveStatus }}</div>

                         <hr>
                        <h6 class="mt-3">Fetch Available Models</h6>
                        <p class="small text-muted">If you've entered an API key for OpenRouter, you can try to fetch the latest available models. For Gemini and Claude, model lists are typically predefined.</p>
                        <div class="input-group input-group-sm mb-2">
                            <select class="form-select" v-model="serviceToFetchModelsFor">
                                <option value="openrouter">OpenRouter</option>
                                <option value="gemini" disabled>Gemini (Uses Predefined List)</option>
                                <option value="claude" disabled>Claude (Uses Predefined List)</option>
                            </select>
                            <button class="btn btn-outline-info" type="button" @click="fetchModelsForService()" :disabled="serviceToFetchModelsFor !== 'openrouter' || !apiKeys[serviceToFetchModelsFor]">
                                <i class="bi bi-arrow-clockwise"></i> Fetch Models
                            </button>
                        </div>
                        <div v-if="modelFetchStatus" class="alert alert-info alert-sm py-1 px-2">{{ modelFetchStatus }}</div>
                         

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @click="closeApiSettingsModal">Cancel</button>
                        <button type="button" class="btn btn-primary" @click="saveApiKeys"><i class="bi bi-save"></i> Save Keys</button>
                    </div>
                </div>
            </div>
        </div>
        {% endraw %}
    </div> <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/vue@3.2.47/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>

</body>
</html>
